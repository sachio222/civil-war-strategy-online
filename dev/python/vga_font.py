"""vga_font.py - Pixel-perfect fonts for CWS.

Two fonts:
  1. IBM VGA 8x16 bitmap font (full ASCII 32-126) for LOCATE/PRINT text.
  2. QB DRAW-string mini font (A-Z, 6px wide) for city name labels.
"""

import pygame

CHAR_W = 8
CHAR_H = 16

# fmt: off
_GLYPHS = {
 32: bytes([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
 33: bytes([0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00]),
 34: bytes([0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
 35: bytes([0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00]),
 36: bytes([0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00]),
 37: bytes([0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00]),
 38: bytes([0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00]),
 39: bytes([0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
 40: bytes([0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00]),
 41: bytes([0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00]),
 42: bytes([0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00]),
 43: bytes([0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00]),
 44: bytes([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00]),
 45: bytes([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
 46: bytes([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00]),
 47: bytes([0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00]),
 48: bytes([0x00,0x00,0x7C,0xC6,0xC6,0xCE,0xDE,0xF6,0xE6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 49: bytes([0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00]),
 50: bytes([0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00]),
 51: bytes([0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 52: bytes([0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00]),
 53: bytes([0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 54: bytes([0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 55: bytes([0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00]),
 56: bytes([0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 57: bytes([0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00]),
 58: bytes([0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00]),
 59: bytes([0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00]),
 60: bytes([0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00]),
 61: bytes([0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
 62: bytes([0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00]),
 63: bytes([0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00]),
 64: bytes([0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00]),
 65: bytes([0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00]),
 66: bytes([0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00]),
 67: bytes([0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00]),
 68: bytes([0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00]),
 69: bytes([0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00]),
 70: bytes([0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00]),
 71: bytes([0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00]),
 72: bytes([0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00]),
 73: bytes([0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00]),
 74: bytes([0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00]),
 75: bytes([0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00]),
 76: bytes([0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00]),
 77: bytes([0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00]),
 78: bytes([0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00]),
 79: bytes([0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 80: bytes([0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00]),
 81: bytes([0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00]),
 82: bytes([0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00]),
 83: bytes([0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 84: bytes([0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00]),
 85: bytes([0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00]),
 86: bytes([0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00]),
 87: bytes([0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00]),
 88: bytes([0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00]),
 89: bytes([0x00,0x00,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00]),
 90: bytes([0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00]),
 91: bytes([0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00]),
 92: bytes([0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00]),
 93: bytes([0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00]),
 94: bytes([0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
 95: bytes([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00]),
 96: bytes([0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
 97: bytes([0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00]),
 98: bytes([0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00]),
 99: bytes([0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00]),
100: bytes([0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00]),
101: bytes([0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00]),
102: bytes([0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00]),
103: bytes([0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00]),
104: bytes([0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00]),
105: bytes([0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00]),
106: bytes([0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00]),
107: bytes([0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00]),
108: bytes([0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00]),
109: bytes([0x00,0x00,0x00,0x00,0x00,0xE6,0xFF,0xDB,0xDB,0xDB,0xDB,0xDB,0x00,0x00,0x00,0x00]),
110: bytes([0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00]),
111: bytes([0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00]),
112: bytes([0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00]),
113: bytes([0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00]),
114: bytes([0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00]),
115: bytes([0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00]),
116: bytes([0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00]),
117: bytes([0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00]),
118: bytes([0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x00,0x00,0x00,0x00]),
119: bytes([0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00]),
120: bytes([0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00]),
121: bytes([0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00]),
122: bytes([0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00]),
123: bytes([0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00]),
124: bytes([0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00]),
125: bytes([0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00]),
126: bytes([0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]),
}
# fmt: on


def _build_glyph_surfaces():
    """Pre-render every glyph as a white-on-transparent 8x16 Surface."""
    white = (255, 255, 255, 255)
    cache = {}
    for code, data in _GLYPHS.items():
        surf = pygame.Surface((CHAR_W, CHAR_H), pygame.SRCALPHA)
        for row_idx, byte_val in enumerate(data):
            for bit in range(8):
                if byte_val & (0x80 >> bit):
                    surf.set_at((bit, row_idx), white)
        cache[code] = surf
    return cache


# Lazily initialised after pygame.init()
_glyph_cache: dict | None = None
# Per-color tinted surfaces: {(code, color_tuple): Surface}
_color_cache: dict = {}


def get_glyph(char_code: int, rgb: tuple) -> pygame.Surface:
    """Return an 8x16 Surface for *char_code* tinted to *rgb*."""
    global _glyph_cache
    if _glyph_cache is None:
        _glyph_cache = _build_glyph_surfaces()

    key = (char_code, rgb)
    surf = _color_cache.get(key)
    if surf is None:
        base = _glyph_cache.get(char_code)
        if base is None:
            base = _glyph_cache[32]  # fallback to space
        # Tint white glyph to target color using BLEND_RGBA_MULT
        surf = base.copy()
        surf.fill(rgb + (255,), special_flags=pygame.BLEND_RGBA_MULT)
        _color_cache[key] = surf
    return surf


# ═══════════════════════════════════════════════════════════════════════════
#  QB DRAW-string mini font for city name labels (A-Z only, ~5x5 px)
# ═══════════════════════════════════════════════════════════════════════════

# Exact DATA from CWSTRAT.BAS lines 719-725, indexed 1-26 = A-Z
_DRAW_FONT_RAW = [
    "U2E2F2D2BU1L3",                   # A
    "U4R3F1G1L2BR2BF1G1L2",            # B
    "H1U2E1R2F1BD2G1L1",               # C (fixed from original)
    "U4R3F1D1D1G1L2",                  # D
    "U4R3BD2BL1L2D2R3",                # E
    "U4R3BD2BL1L2",                    # F
    "H1U2E1R3BD2L2BD2R2U1",            # G
    "U4BD2BR1R3U2BD3D1",               # H
    "R1U4L1R2BL1BD4R1",                # I
    "R1E1U3BG3F1",                     # J
    "U4BR3G2F2",                       # K
    "U4BD4BR1R1",                      # L
    "U4F2E2D4",                        # M
    "U4F4U4",                          # N
    "H1U2E1R2F1D2G1L1",               # O
    "U4R3F1G1L2",                      # P
    "H1U2E1R2F1D2G1L1BE1F1R1",        # Q
    "U4R3F1G1L2BR1F2",                # R
    "R3E1H1L2H1E1R3",                 # S
    "U4L2BR3R1",                       # T
    "H1U3BR4D3G1L1",                   # U (fixed from original)
    "H2U2BR4D2G2",                     # V
    "H2U2BF3BU1D1F1E2U2",             # W (fixed from original)
    "E4BD4H4",                         # X
    "U2H2BR4G2",                       # Y
    "E4L4BD4R4",                       # Z
]

# Direction vectors for DRAW commands: U D L R E F G H
_DIR = {
    'U': (0, -1), 'D': (0, 1), 'L': (-1, 0), 'R': (1, 0),
    'E': (1, -1), 'F': (1, 1), 'G': (-1, 1), 'H': (-1, -1),
}


def _render_draw_string(draw_str: str) -> list[tuple[int, int]]:
    """Execute a QB DRAW string, return list of pixels to plot.

    Supports: U D L R E F G H (move+draw), B prefix (move only),
    digit after command = repeat count. Ignores C/S commands.
    Origin (0,0) is included — matches QB PSET before DRAW.
    """
    pixels = [(0, 0)]  # PSET draws the origin pixel
    x, y = 0, 0
    i = 0
    blank = False  # B prefix: move without drawing
    while i < len(draw_str):
        ch = draw_str[i].upper()
        i += 1
        if ch == 'B':
            blank = True
            continue
        if ch in ('C', 'S'):
            # Skip color/scale + following digits
            while i < len(draw_str) and draw_str[i].isdigit():
                i += 1
            continue
        if ch in _DIR:
            dx, dy = _DIR[ch]
            # Parse optional count
            count = 0
            while i < len(draw_str) and draw_str[i].isdigit():
                count = count * 10 + int(draw_str[i])
                i += 1
            if count == 0:
                count = 1
            # QB DRAW draws from current pos to destination (inclusive).
            # Add starting pixel so segments after B-moves aren't gapped.
            if not blank:
                pixels.append((x, y))
            for _ in range(count):
                x += dx
                y += dy
                if not blank:
                    pixels.append((x, y))
            blank = False
            continue
        # Unknown char, skip
        blank = False
    return pixels


# Fixed canvas for DRAW glyphs.  Origin (PSET point) sits at (OX, OY).
# Letters extend up to 2px left, 4px right, 4px up from origin.
DRAW_CELL_W = 7
DRAW_CELL_H = 5
DRAW_OX = 2   # origin x within canvas
DRAW_OY = 4   # origin y within canvas (baseline)


def _build_draw_glyphs() -> dict[int, pygame.Surface]:
    """Pre-render A-Z DRAW font on a fixed 7x5 canvas, origin at (2,4)."""
    cache = {}
    white = (255, 255, 255, 255)
    for idx, draw_str in enumerate(_DRAW_FONT_RAW):
        pixels = _render_draw_string(draw_str)
        surf = pygame.Surface((DRAW_CELL_W, DRAW_CELL_H), pygame.SRCALPHA)
        for px, py in pixels:
            sx = px + DRAW_OX
            sy = py + DRAW_OY
            if 0 <= sx < DRAW_CELL_W and 0 <= sy < DRAW_CELL_H:
                surf.set_at((sx, sy), white)
        cache[65 + idx] = surf
    # Space / period / comma — small transparent placeholders
    cache[32] = pygame.Surface((DRAW_CELL_W, DRAW_CELL_H), pygame.SRCALPHA)
    dot = pygame.Surface((DRAW_CELL_W, DRAW_CELL_H), pygame.SRCALPHA)
    dot.set_at((DRAW_OX, DRAW_OY), white)
    cache[46] = dot          # .
    cache[44] = dot.copy()   # ,
    return cache


_draw_glyph_cache: dict | None = None
_draw_color_cache: dict = {}


def get_draw_glyph(char_code: int, rgb: tuple) -> pygame.Surface | None:
    """Return a small DRAW-font surface for A-Z/space/period, or None."""
    global _draw_glyph_cache
    if _draw_glyph_cache is None:
        _draw_glyph_cache = _build_draw_glyphs()

    key = (char_code, rgb)
    surf = _draw_color_cache.get(key)
    if surf is not None:
        return surf

    base = _draw_glyph_cache.get(char_code)
    if base is None:
        return None
    surf = base.copy()
    surf.fill(rgb + (255,), special_flags=pygame.BLEND_RGBA_MULT)
    _draw_color_cache[key] = surf
    return surf
